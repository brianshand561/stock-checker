name: Infrastructure Deployment

on:
  workflow_dispatch:

jobs:
  infra-deployment:
    runs-on: ubuntu-latest
      
    steps:
      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 16

      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install and Test
        run: |
          npm i -g --force yarn  
          yarn install 

      - name: Infrastructure Test
        run: npm run test
          
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          
          role-to-assume: ${{ env.AWS_ROLE_TO_ASSUME }}
          role-duration-seconds: 2400
          aws-region: "us-east-1"
          role-skip-session-tagging: true

      - name: CDK Deploy
        run: |
          npm install -g aws-cdk@2.64.0
          cdk deploy --all --require-approval=never --outputs-file ./distributionLink.json

      - name: Summary Report
        run: |
          CFDistributionId=$(jq -r '.["so284-cxw-test-91323-Test app"].CFDistributionId' < distributionLink.json)
          echo $CFDistributionId
          LINE1="## :rocket: CloudFront URL: [${CFDistributionId}](https://${CFDistributionId}) :rocket:"
          echo $LINE1 >> $GITHUB_STEP_SUMMARY